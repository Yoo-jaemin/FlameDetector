/*
*******************************************************************************
* COPYRIGHT (c) 1992-2012 GASTRON Co.,Ltd. All rights reserved.
*******************************************************************************
* Model Name	: GTF-1100 Series
* Module name	: 
* Description	: 
* Version		: REV 0.51
* Start Date	: 2017.01.17
* Modify Date	: 2018.06.14
* C-Compiler	: avr-gcc
* MPU			: ATmega1281
* Written by	: Min-Sung, Kang (mskang@gastron.com)
*******************************************************************************
*/

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#include "global.h"
#include "dbg_printf.h"

#include "dac7571.h"
#include "sw_lib.h"
#include "timer.h"
#include "gpio.h"

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void Initialize_DAC7571( void );
void DAC7571_Start( void );
void DAC7571_Stop( void );
U8 DAC7571_AckRead( void );
U8 DAC7571_Byte_Wr( U8 bData );
U8 DAC7571_Standard_Wr( U16 wData );

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void Initialize_DAC7571( void )
{
	DAC7571_SCL_H();
	DAC7571_SDA_H();
	
	MA_OUT_ENA();
	
	Delay_ms( 5 );
	
	DAC7571_uA_Wr( 4000 );
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void DAC7571_Start( void )
{
	DAC7571_SDA_H();
	Delay_us( 10 );
	DAC7571_SCL_H();
	Delay_us( 10 );
	DAC7571_SDA_L();
	Delay_us( 10 );
	DAC7571_SCL_L();
	Delay_us( 10 );
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void DAC7571_Stop( void )
{
	DAC7571_SDA_L();
	Delay_us( 10 );
	DAC7571_SCL_H();
	Delay_us( 10 );
	DAC7571_SDA_H();
	Delay_us( 10 );
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

U8 DAC7571_AckRead( void )
{
	U8		bAck;
	
	DAC7571_SCL_H();
	Delay_us( 10 );
	bAck = DAC7571_SDA_R();
	DAC7571_SCL_L();
	Delay_us( 10 );
	
	return bAck;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

U8 DAC7571_Byte_Wr( U8 bData )
{
	U16		i;
	
	for( i=0; i<8; i++ ){
		if( bData & 0x80 ){
			DAC7571_SDA_H();	
		}
		else {
			DAC7571_SDA_L();	
		}
		bData <<= 1;
		DAC7571_SCL_H();
		Delay_us( 10 );
		DAC7571_SCL_L();
		Delay_us( 10 );
	}
	
	return DAC7571_AckRead();
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

U8 DAC7571_Standard_Wr( U16 wData )
{
	U8		bAck = 0;
	
	DAC7571_Start();
	if( DAC7571_Byte_Wr( 0x98 ) ){
		bAck |= 1;
	}
	if( DAC7571_Byte_Wr( wData >> 8 & 255 )){
		bAck |= 2;
	}
	if( !DAC7571_Byte_Wr( wData & 255 )){
		bAck |= 4;
	}
	DAC7571_Stop();
	
	return bAck;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

U8 DAC7571_uA_Wr( U16 uA )
{
	return DAC7571_Standard_Wr( DAC7571_uA_Value( uA ) );
}

/*
*******************************************************************************
* COPYRIGHT (c) 1992-2012 GASTRON Co.,Ltd. All rights reserved.
*******************************************************************************
* Model Name	: GTF-1100 Series
* Module name	: 
* Description	: 
* Version		: REV 0.51
* Start Date	: 2017.01.17
* Modify Date	: 2018.06.14
* C-Compiler	: avr-gcc
* MPU			: ATmega1281
* Written by	: Min-Sung, Kang (mskang@gastron.com)
*******************************************************************************
*/

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#include <avr/io.h>

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#include "global.h"
#include "gpio.h"
#include "timer.h"
#include "mmi.h"

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void Initialize_GPIO(void);
void SMPS_RESET( void );

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void Initialize_GPIO(void)
{
	//-----+-----+-------------------------------------+
	// PORT A SETTING.(OUT-1, IN-0)
	//-----+-----+-----+-------------------------------+
	//     |BIT7 | IN  | -
	//-----+-----+-----+-------------------------------+
	//     |BIT6 | IN  | -
	//-----+-----+-----+-------------------------------+
	//     |BIT5 | OUT | TP5
	//-----+-----+-----+-------------------------------+
	//     |BIT4 | OUT | TP4
	//-----+-----+-----+-------------------------------+
	//     |BIT3 | OUT | TP3
	//-----+-----+-----+-------------------------------+
	//     |BIT2 | IN  | -
	//-----+-----+-----+-------------------------------+
	//     |BIT1 | IN  | -
	//-----+-----+-----+-------------------------------+
	//     |BIT0 | IN  | -
	//-----+-----+-------------------------------------+	
	DDRA	= 0x38;		//0011 1000
	PORTA	= 0x00;		//0000 0000
	
	//-----+-----+-------------------------------------+
	// PORT B SETTING.(OUT-1, IN-0)
	//-----+-----+-----+-------------------------------+
	//     |BIT7 | IN  | TYPE (L = UV/IR, H = Triple-IR)
	//-----+-----+-----+-------------------------------+
	//     |BIT6 | IN  | -
	//-----+-----+-----+-------------------------------+
	//     |BIT5 | OUT | Trouble Relay
	//-----+-----+-----+-------------------------------+
	//     |BIT4 | OUT | Alarm Relay
	//-----+-----+-----+-------------------------------+
	//     |BIT3 | IN  | nB.I.T.
	//-----+-----+-----+-------------------------------+
	//     |BIT2 | IN  | -
	//-----+-----+-----+-------------------------------+
	//     |BIT1 | IN  | PSCK
	//-----+-----+-----+-------------------------------+
	//     |BIT0 | IN  | -
	//-----+-----+-------------------------------------+
	DDRB	= 0x30;		//0011 0000
	PORTB	= 0x82;		//1000 0010
	
	//-----+-----+-------------------------------------+
	// PORT C SETTING.(OUT-1, IN-0)
	//-----+-----+-----+-------------------------------+
	//     |BIT7 | IN  | 
	//-----+-----+-----+-------------------------------+
	//     |BIT6 | IN  | -
	//-----+-----+-----+-------------------------------+
	//     |BIT5 | IN  | -
	//-----+-----+-----+-------------------------------+
	//     |BIT4 | IN  | NODE ADDRESS MSB
	//-----+-----+-----+-------------------------------+
	//     |BIT3 | IN  | -
	//-----+-----+-----+-------------------------------+
	//     |BIT2 | IN  | -
	//-----+-----+-----+-------------------------------+
	//     |BIT1 | IN  | -
	//-----+-----+-----+-------------------------------+
	//     |BIT0 | IN  | NODE ADDRESS LSB
	//-----+-----+-------------------------------------+
	DDRC	= 0x00;		//0000 0000
	PORTC	= 0xFF;		//1111 1111
	
	//-----+-----+-------------------------------------+
	// PORT D SETTING.(OUT-1, IN-0)
	//-----+-----+-----+-------------------------------+
	//     |BIT7 | OUT | LED-RED
	//-----+-----+-----+-------------------------------+
	//     |BIT6 | IN  | nUV-CNT
	//-----+-----+-----+-------------------------------+
	//     |BIT5 | OUT | LED-GREEN
	//-----+-----+-----+-------------------------------+
	//     |BIT4 | OUT | nRS485_RxEN
	//-----+-----+-----+-------------------------------+
	//     |BIT3 | OUT | RS485_TX
	//-----+-----+-----+-------------------------------+
	//     |BIT2 | IN  | RS485_RX
	//-----+-----+-----+-------------------------------+
	//     |BIT1 | IN  | -
	//-----+-----+-----+-------------------------------+
	//     |BIT0 | IN  | -
	//-----+-----+-------------------------------------+
	DDRD	= 0xB8;		//1011 1000
	PORTD	= 0x0C;		//0000 1100
	
	//-----+-----+-------------------------------------+
	// PORT E SETTING.(OUT-1, IN-0)
	//-----+-----+-----+-------------------------------+
	//     |BIT7 | OUT | TEST LAMP (IR)
	//-----+-----+-----+-------------------------------+
	//     |BIT6 | OUT | TEST LAMP (UV)
	//-----+-----+-----+-------------------------------+
	//     |BIT5 | IN  | -
	//-----+-----+-----+-------------------------------+
	//     |BIT4 | IN  | -
	//-----+-----+-----+-------------------------------+
	//     |BIT3 | OUT | DAC7571 SDA
	//-----+-----+-----+-------------------------------+
	//     |BIT2 | OUT | DAC7571 SCL
	//-----+-----+-----+-------------------------------+
	//     |BIT1 | OUT | DEBUG Tx (PDO)
	//-----+-----+-----+-------------------------------+
	//     |BIT0 | IN  | DEBUG Rx (PDI)
	//-----+-----+-------------------------------------+
	DDRE	= 0xCE;		//1100 1110
	PORTE	= 0x4F;		//0100 1111
	
	//-----+-----+-------------------------------------+
	// PORT F SETTING.(OUT-1, IN-0)
	//-----+-----+-----+-------------------------------+
	//     |BIT7 | IN  | -
	//-----+-----+-----+-------------------------------+
	//     |BIT6 | IN  | -
	//-----+-----+-----+-------------------------------+
	//     |BIT5 | IN  | ADC - IR3 (5.30um) or TLUV-BL
	//-----+-----+-----+-------------------------------+
	//     |BIT4 | IN  | ADC - IR2 (3.95um) or SMPS-EN
	//-----+-----+-----+-------------------------------+
	//     |BIT3 | IN  | ADC - IR1 (4.30um)
	//-----+-----+-----+-------------------------------+
	//     |BIT2 | IN  | ADC - NTC
	//-----+-----+-----+-------------------------------+
	//     |BIT1 | IN  | ADC - Input Power
	//-----+-----+-----+-------------------------------+
	//     |BIT0 | IN  | ADC - UV Power
	//-----+-----+-------------------------------------+
	DDRF	= 0x00;		//0000 0000
	PORTF	= 0x00;		//0000 0000
	
	//-----+-----+-------------------------------------+
	// PORT G SETTING.(OUT-1, IN-0)
	//-----+-----+-----+-------------------------------+
	//     |BIT7 | IN  | -
	//-----+-----+-----+-------------------------------+
	//     |BIT6 | IN  | -
	//-----+-----+-----+-------------------------------+
	//     |BIT5 | IN  | -
	//-----+-----+-----+-------------------------------+
	//     |BIT4 | OUT | nMA-EN
	//-----+-----+-----+-------------------------------+
	//     |BIT3 | OUT | LED-ALM
	//-----+-----+-----+-------------------------------+
	//     |BIT2 | IN  | -
	//-----+-----+-----+-------------------------------+
	//     |BIT1 | IN  | -
	//-----+-----+-----+-------------------------------+
	//     |BIT0 | IN  | -
	//-----+-----+-------------------------------------+
    DDRG	= 0x18;		//0001 1000
    PORTG	= 0x10;		//0001 1000
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void Alarm_Relay_On( void )
{
	if( AlarmRelayMode == RLY_ENERGIZED ){
		ALM_RLY_L();
	}
	else {
		ALM_RLY_H();
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void Alarm_Relay_Off( void )
{
	if( AlarmRelayMode == RLY_ENERGIZED ){
		ALM_RLY_H();
	}
	else {
		ALM_RLY_L();
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

U8 Alarm_Relay_Check( void )
{
	U8		ret = 0;
	
	if( AlarmRelayMode == RLY_ENERGIZED ){
		if( ALM_RLY_CHK() == 0 ){
			ret = 1;
		}
	}
	else {
		if( ALM_RLY_CHK() == 1 ){
			ret = 1;
		}
	}
	
	return ret;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void Trouble_Relay_On( void )
{
	if( TroubleRelayMode == RLY_ENERGIZED ){
		TRB_RLY_L();
	}
	else {
		TRB_RLY_H();
	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void Trouble_Relay_Off( void )
{
	if( TroubleRelayMode == RLY_ENERGIZED ){
		TRB_RLY_H();
	}
	else {
		TRB_RLY_L();
	}
}
